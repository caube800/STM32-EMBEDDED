#include <string.h>
#include <stdio.h>
#include <stdlib.h>
#include "ssd1306.h"
#include "ssd1306_tests.h"
#include "ssd1306_fonts.h"

static int player_y;
static int player_anim_frame;
static int is_jumping;
static int jump_velocity;
static int ground_scroll;
static bool game_over;
static bool night;
static bool has_collided;
static int score;
static int hi_score = 0;
static int lives;
static int target_fps;
static int game_cycle_counter;

static const int gravity = 2;
static const int jump_initial_velocity = 12;
static const int ground_speed = 3;

#define PLAYER_SAFE_ZONE_WIDTH 32
#define SPAWN_NEW_LIVE_MIN_CYCLES 800
#define DAY_NIGHT_SWITCH_CYCLES 1000

#define LIVES_START 3
#define LIVES_MAX 5
#define TARGET_FPS_MAX 55
#define GROUND_Y 57
#define GROUND_CACTI_SCROLL_SPEED 3

// --- Cấu trúc dữ liệu ---
typedef struct {
    uint8_t x, y;
    uint8_t w, h;
    const uint8_t *bitmap;
    const uint8_t *mask;
} Cactus_t;

#define NUM_CACTI 5
static Cactus_t cacti[NUM_CACTI];

const uint8_t trex_up_1s_bitmap[] = {
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x07, 0xfe, 0x00,
    0x00, 0x06, 0xff, 0x00,
    0x00, 0x0e, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xc0, 0x00,
    0x00, 0x0f, 0xfc, 0x00,
    0x40, 0x0f, 0xc0, 0x00,
    0x40, 0x1f, 0x80, 0x00,
    0x40, 0x7f, 0x80, 0x00,
    0x60, 0xff, 0xe0, 0x00,
    0x71, 0xff, 0xa0, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x3f, 0xff, 0x00, 0x00,
    0x1f, 0xff, 0x00, 0x00,
    0x0f, 0xfe, 0x00, 0x00,
    0x03, 0xfc, 0x00, 0x00,
    0x01, 0xdc, 0x00, 0x00,
    0x01, 0x8c, 0x00, 0x00,
    0x01, 0x8c, 0x00, 0x00,
    0x01, 0x0c, 0x00, 0x00,
    0x01, 0x8e, 0x00, 0x00
};

const uint8_t trex_up_1s_mask[] = {  // Copy bitmap cho mask cơ bản (set 0xFF ở vùng pixel để clear)
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x07, 0xfe, 0x00,
    0x00, 0x07, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xc0, 0x00,
    0x00, 0x0f, 0xfc, 0x00,
    0x40, 0x0f, 0xc0, 0x00,
    0x40, 0x1f, 0x80, 0x00,
    0x40, 0x7f, 0x80, 0x00,
    0x60, 0xff, 0xe0, 0x00,
    0x71, 0xff, 0xa0, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x3f, 0xff, 0x00, 0x00,
    0x1f, 0xff, 0x00, 0x00,
    0x0f, 0xfe, 0x00, 0x00,
    0x03, 0xfc, 0x00, 0x00,
    0x01, 0xdc, 0x00, 0x00,
    0x01, 0x8c, 0x00, 0x00,
    0x01, 0x8c, 0x00, 0x00,
    0x01, 0x0c, 0x00, 0x00,
    0x01, 0x8e, 0x00, 0x00
};

const uint8_t trex_up_2s_bitmap[] = {
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x07, 0xfe, 0x00,
    0x00, 0x06, 0xff, 0x00,
    0x00, 0x0e, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xc0, 0x00,
    0x00, 0x0f, 0xfc, 0x00,
    0x40, 0x0f, 0xc0, 0x00,
    0x40, 0x1f, 0x80, 0x00,
    0x40, 0x7f, 0x80, 0x00,
    0x60, 0xff, 0xe0, 0x00,
    0x71, 0xff, 0xa0, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x3f, 0xff, 0x00, 0x00,
    0x1f, 0xff, 0x00, 0x00,
    0x0f, 0xfe, 0x00, 0x00,
    0x03, 0xfc, 0x00, 0x00,
    0x01, 0xfc, 0x00, 0x00,
    0x01, 0x8c, 0x00, 0x00,
    0x01, 0x8c, 0x00, 0x00,
    0x01, 0x0e, 0x00, 0x00,
    0x01, 0x86, 0x00, 0x00
};

const uint8_t trex_up_2s_mask[] = {  // Tương tự, copy và adjust nếu cần
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x07, 0xfe, 0x00,
    0x00, 0x07, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xc0, 0x00,
    0x00, 0x0f, 0xfc, 0x00,
    0x40, 0x0f, 0xc0, 0x00,
    0x40, 0x1f, 0x80, 0x00,
    0x40, 0x7f, 0x80, 0x00,
    0x60, 0xff, 0xe0, 0x00,
    0x71, 0xff, 0xa0, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x3f, 0xff, 0x00, 0x00,
    0x1f, 0xff, 0x00, 0x00,
    0x0f, 0xfe, 0x00, 0x00,
    0x03, 0xfc, 0x00, 0x00,
    0x01, 0xfc, 0x00, 0x00,
    0x01, 0x8c, 0x00, 0x00,
    0x01, 0x8c, 0x00, 0x00,
    0x01, 0x0e, 0x00, 0x00,
    0x01, 0x86, 0x00, 0x00
};

const uint8_t trex_up_3s_bitmap[] = {
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x07, 0xfe, 0x00,
    0x00, 0x06, 0xff, 0x00,
    0x00, 0x0e, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xc0, 0x00,
    0x00, 0x0f, 0xfc, 0x00,
    0x40, 0x0f, 0xc0, 0x00,
    0x40, 0x1f, 0x80, 0x00,
    0x40, 0x7f, 0x80, 0x00,
    0x60, 0xff, 0xe0, 0x00,
    0x71, 0xff, 0xa0, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x3f, 0xff, 0x00, 0x00,
    0x1f, 0xff, 0x00, 0x00,
    0x0f, 0xfe, 0x00, 0x00,
    0x03, 0xfc, 0x00, 0x00,
    0x01, 0xdc, 0x00, 0x00,
    0x01, 0x8c, 0x00, 0x00,
    0x01, 0x8c, 0x00, 0x00,
    0x01, 0x06, 0x00, 0x00,
    0x01, 0x83, 0x00, 0x00
};

const uint8_t trex_up_3s_mask[] = {  // Copy và adjust
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x07, 0xfe, 0x00,
    0x00, 0x07, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xc0, 0x00,
    0x00, 0x0f, 0xfc, 0x00,
    0x40, 0x0f, 0xc0, 0x00,
    0x40, 0x1f, 0x80, 0x00,
    0x40, 0x7f, 0x80, 0x00,
    0x60, 0xff, 0xe0, 0x00,
    0x71, 0xff, 0xa0, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x3f, 0xff, 0x00, 0x00,
    0x1f, 0xff, 0x00, 0x00,
    0x0f, 0xfe, 0x00, 0x00,
    0x03, 0xfc, 0x00, 0x00,
    0x01, 0xdc, 0x00, 0x00,
    0x01, 0x8c, 0x00, 0x00,
    0x01, 0x8c, 0x00, 0x00,
    0x01, 0x06, 0x00, 0x00,
    0x01, 0x83, 0x00, 0x00
};

const uint8_t trex_duck_1s_bitmap[] = {
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x1f, 0xff, 0xc0, 0x08, 0x46,
    0x1f, 0xe0, 0x70, 0xff, 0x3f,
    0x7f, 0xff, 0xf7, 0xf0, 0x3f,
    0xff, 0xff, 0xf0, 0x9f, 0xff,
    0xff, 0xf0, 0xcf, 0xff, 0xff,
    0xf0, 0xe7, 0xff, 0xfe, 0x00,
    0xf3, 0xff, 0x9f, 0xc0, 0xc1,
    0xf9, 0x00, 0x00, 0xc3, 0x9d
};

const uint8_t trex_duck_1s_mask[] = {
    0xe0, 0x00, 0x3f, 0xf0, 0xf9,
    0xff, 0xff, 0xf8, 0xff, 0xff,
    0xff, 0xf8, 0xff, 0xff, 0xff,
    0xf8, 0xff, 0xff, 0xff, 0xf8,
    0x7f, 0xff, 0xff, 0xf8, 0x3f,
    0xff, 0xff, 0xf8, 0x1f, 0xff,
    0xff, 0xf8, 0x0f, 0xff, 0xff,
    0xe0, 0x07, 0xff, 0xff, 0xe0,
    0x07, 0xff, 0xc0, 0x00, 0x07,
    0x9f, 0xc0, 0x00, 0x07, 0x80,
    0x00, 0x00, 0x07, 0x80, 0x00,
    0x00, 0x07, 0x80, 0x00, 0x00,
    0x07, 0x80, 0x00, 0x00, 0x07,
    0x80, 0x00, 0x00, 0x07, 0x80,
    0x00, 0x00, 0x07, 0x80, 0x00,
    0x00, 0x07, 0x80, 0x00, 0x00,
    0x07, 0x80, 0x00, 0x00, 0x07,
    0x80, 0x00, 0x00
};

const uint8_t trex_duck_2s_bitmap[] = {
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x1f, 0xff, 0xc0, 0x08, 0x46,
    0x1f, 0xe0, 0x70, 0xff, 0x3f,
    0x7f, 0xff, 0xf7, 0xf0, 0x3f,
    0xff, 0xff, 0xf0, 0x9f, 0xff,
    0xff, 0xf0, 0xcf, 0xff, 0xff,
    0xf0, 0xe7, 0xff, 0xfe, 0x00,
    0xf3, 0xff, 0x9f, 0xc0, 0xc1,
    0xf9, 0x00, 0x00, 0xc3, 0x9d
};

const uint8_t trex_duck_2s_mask[] = {
    0xe0, 0x00, 0x3f, 0xf0, 0xf9,
    0xff, 0xff, 0xf8, 0xff, 0xff,
    0xff, 0xf8, 0xff, 0xff, 0xff,
    0xf8, 0xff, 0xff, 0xff, 0xf8,
    0x7f, 0xff, 0xff, 0xf8, 0x3f,
    0xff, 0xff, 0xf8, 0x1f, 0xff,
    0xff, 0xf8, 0x0f, 0xff, 0xff,
    0xe0, 0x07, 0xff, 0xff, 0xe0,
    0x07, 0xff, 0xc0, 0x00, 0x07,
    0x9f, 0xc0, 0x00, 0x07, 0x80,
    0x00, 0x00, 0x07, 0x80, 0x00,
    0x00, 0x07, 0x80, 0x00, 0x00,
    0x07, 0x80, 0x00, 0x00, 0x07,
    0x80, 0x00, 0x00, 0x07, 0x80,
    0x00, 0x00, 0x07, 0x80, 0x00,
    0x00, 0x07, 0x80, 0x00, 0x00,
    0x07, 0x80, 0x00, 0x00, 0x07,
    0x80, 0x00, 0x00
};

const uint8_t ground_bitmap[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x10, 0x00, 0x04, 0x00, 0x10, 0x00, 0x04, 0x00, 0x10, 0x00, 0x04, 0x00, 0x10, 0x00, 0x04, 0x00,
    0x28, 0x00, 0x0a, 0x00, 0x28, 0x00, 0x0a, 0x00, 0x28, 0x00, 0x0a, 0x00, 0x28, 0x00, 0x0a, 0x00,
    0x54, 0x00, 0x15, 0x00, 0x54, 0x00, 0x15, 0x00, 0x54, 0x00, 0x15, 0x00, 0x54, 0x00, 0x15, 0x00,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
};  // Tổng 128 bytes (16 bytes x 8 rows)

const uint8_t cacti_big_big_bitmap[] = {

0x00, 0x00, 0x00, 0x00, 0x7B, 0x7B, 0xDB, 0xE0, 0x77, 0xBB, 0xBD, 0xE0, 0x77, 0xBE, 0xBD, 0xE0,
0x77, 0xBD, 0x3D, 0xE0, 0x77, 0xAB, 0xBD, 0x60, 0x57, 0x93, 0xBC, 0xA0, 0x27, 0xBB, 0xBD, 0xC0,
0x77, 0xBB, 0xBD, 0xC0, 0x77, 0xBB, 0xBD, 0xC0, 0x77, 0xBB, 0xBD, 0xC0, 0x77, 0xBB, 0xFD, 0xC0,
0x77, 0xB9, 0xFD, 0xC0, 0x77, 0xBA, 0xFF, 0xC0, 0x7F, 0xF7, 0x3F, 0xA0, 0x3F, 0xE8, 0x3F, 0x60,
0x5F, 0x98, 0x3C, 0xE0, 0x67, 0xB8, 0x3D, 0xE0, 0x77, 0xBB, 0xBD, 0xE0, 0x77, 0xBB, 0xBD, 0xE0,
0x77, 0xBB, 0xBC, 0x00, 0x77, 0xBB, 0xBC, 0x00, 0x47, 0x8A, 0x3C, 0x00, 0x5F, 0xAA, 0xFC, 0x60,
0x40, 0x0A, 0x01, 0x60, 0x01, 0x00, 0x40, 0x00,
};

const uint8_t cacti_big_big_mask[] = {

0x03, 0x00, 0x18, 0x00, 0x07, 0x80, 0x3C, 0x00, 0x0F, 0xC0, 0x7E, 0x00, 0x0F, 0xC1, 0x7E, 0x00,
0x0F, 0xC3, 0xFE, 0x00, 0x0F, 0xD7, 0xFE, 0x80, 0x2F, 0xFF, 0xFF, 0xC0, 0x7F, 0xFF, 0xFF, 0xE0,
0xFF, 0xFF, 0xFF, 0xE0, 0xFF, 0xFF, 0xFF, 0xE0, 0xFF, 0xFF, 0xFF, 0xE0, 0xFF, 0xFF, 0xFF, 0xE0,
0xFF, 0xFF, 0xFF, 0xE0, 0xFF, 0xFD, 0xFF, 0xE0, 0xFF, 0xF8, 0xFF, 0xC0, 0x7F, 0xF0, 0x7F, 0x80,
0x3F, 0xE0, 0x7F, 0x00, 0x1F, 0xC0, 0x7E, 0x00, 0x0F, 0xC0, 0x7E, 0x00, 0x0F, 0xC0, 0x7E, 0x00,
0x0F, 0xC0, 0x7E, 0x00, 0x0F, 0xC0, 0x7E, 0x00, 0x3F, 0xF1, 0xFE, 0x00, 0x3F, 0xF1, 0xFF, 0x80,
0x3F, 0xF1, 0xFF, 0x80, 0xFF, 0xFF, 0xFF, 0xE0,
};

const uint8_t cacti_small_big_bitmap[] = {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x68, 0x75, 0xD6, 0xE0,
0x6C, 0xCE, 0xA6, 0x60, 0x6D, 0x2E, 0xB6, 0xA0, 0x4D, 0xAE, 0x36, 0xC0, 0x2D, 0xAE, 0xB6, 0xC0,
0x6D, 0xAE, 0xB6, 0xC0, 0x6D, 0xAE, 0xB6, 0xC0, 0x6D, 0xAE, 0xB6, 0xC0, 0x6F, 0x2E, 0x9E, 0xC0,
0x6C, 0xAE, 0xA7, 0xA0, 0x3D, 0xBE, 0xB6, 0x60, 0x4D, 0xDF, 0xB6, 0xE0, 0x6D, 0xEF, 0x76, 0xE0,
0x6D, 0xEE, 0xF6, 0xE0, 0x6D, 0xEE, 0xF6, 0xE0, 0x6D, 0xEE, 0xF6, 0xE0, 0x6D, 0x8E, 0x16, 0x00,
0x60, 0x20, 0x50, 0x40, 0x01, 0x00, 0x02, 0x00,
};

const uint8_t cacti_small_big_mask[] = {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x06, 0x00, 0x1C, 0x0E, 0x2F, 0x00,
0x1F, 0x3F, 0x7F, 0x80, 0x1F, 0xFF, 0x7F, 0xC0, 0x3F, 0xFF, 0xFF, 0xE0, 0x7F, 0xFF, 0xFF, 0xE0,
0xFF, 0xFF, 0xFF, 0xE0, 0xFF, 0xFF, 0xFF, 0xE0, 0xFF, 0xFF, 0xFF, 0xE0, 0xFF, 0xFF, 0xFF, 0xE0,
0xFF, 0x7F, 0xDF, 0xC0, 0x7E, 0x7F, 0xCF, 0x80, 0x3E, 0x3F, 0xCF, 0x00, 0x1E, 0x1F, 0x8F, 0x00,
0x1E, 0x1F, 0x0F, 0x00, 0x1E, 0x1F, 0x0F, 0x00, 0x1E, 0x1F, 0x0F, 0x00, 0x1E, 0x7F, 0xEF, 0xE0,
0x1F, 0xFF, 0xEF, 0xE0, 0xFF, 0xFF, 0xFF, 0xE0,
};

const uint8_t heart_bitmap[] = {  // W=8, H=8 (placeholder, replace with hearts_5x_bm from GitHub, adjust for single)
    0x00, 0x66, 0xff, 0xff, 0x7e, 0x3c, 0x18, 0x00
};
const uint8_t hi_score_bitmap[] = {  // W=16, H=8 (placeholder, replace with hi_score_bm)
    0xff, 0x81, 0x81, 0x81, 0xff, 0x00, 0xff, 0x81, 0x81, 0x81, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00  // "HI"
};
const uint8_t restart_small_bitmap[] = {
    0x10,
    0x30,
    0x70,
    0xF0,
    0xF0,
    0x70,
    0x30,
    0x10
};

// Hàm vẽ số
static void Render_Number(uint8_t x, uint8_t y, int num) {
    char buf[10];
    sprintf(buf, "%05d", num);
    ssd1306_SetCursor(x, y);
    ssd1306_WriteString(buf, Font_7x10, White);
}

// Hàm vẽ trái tim
static void Render_Heart(int num) {
    for (int i=0; i<num; i++) {
        ssd1306_DrawBitmap(119 - i*7, 0, heart_bitmap, 7, 10, White);
    }
}

// Hàm vẽ mặt đất
static void Render_Ground(uint8_t y) {
    ground_scroll -= ground_speed;
    if (ground_scroll <= -16) ground_scroll = 0;
    for (int i=ground_scroll; i<SSD1306_WIDTH; i += 16) {
        ssd1306_Line(i, y, i+7, y, White);
        ssd1306_Line(i+7, y, i+7, y-3+1, White);
        ssd1306_Line(i+7, y-3+1, i+10, y-3+1, White);
    }
}

// Hàm vẽ bitmap với mask (giữ nguyên từ file .c gốc)
void ssd1306_DrawBitmap_Masked(uint8_t x, uint8_t y, const uint8_t *bitmap, const uint8_t *mask, uint8_t w, uint8_t h, SSD1306_COLOR color) {
    uint8_t byteWidth = (w + 7) / 8;
    uint8_t byte = 0, mask_byte = 0;
    for (uint8_t j = 0; j < h; j++, y++) {
        for (uint8_t i = 0; i < w; i++) {
            if (i & 7) {
                byte <<= 1;
                mask_byte <<= 1;
            } else {
                byte = (*(const unsigned char *)(&bitmap[j * byteWidth + i / 8]));
                mask_byte = (*(const unsigned char *)(&mask[j * byteWidth + i / 8]));
            }
            if (mask_byte & 0x80) {
                if (byte & 0x80) {
                    ssd1306_DrawPixel(x + i, y, color);
                } else {
                    ssd1306_DrawPixel(x + i, y, !color);
                }
            }
        }
    }
}

// Hàm reset game (HÀM MỚI)
static void Reset_Game(void) {
    player_y = 40;
    player_anim_frame = 0;
    is_jumping = 0;
    jump_velocity = 0;
    ground_scroll = 0;
    game_over = false;
    night = false;
    has_collided = false;
    score = 0;
    lives = LIVES_START;
    target_fps = TARGET_FPS_START;
    game_cycle_counter = 0;

    // Xóa hết xương rồng
    for (int i = 0; i < NUM_CACTI; i++) {
        cacti[i].x = 0;
    }

    // Set lại màu bình thường
    ssd1306_WriteCommand(0xA6);
}

void Game_Init(void) {
    ssd1306_Fill(Black);
    ssd1306_UpdateScreen();
    Reset_Game();
}

void Game_HandleInput(void) {
    // Kiểm tra cờ sự kiện nút nhấn
    if (g_button_press_event) {

        // 1. Xóa cờ ngay lập tức
        g_button_press_event = false;

        // 2. XỬ LÝ SỰ KIỆN
        if (game_over) {
            // Nếu đang game over -> Reset game
            Reset_Game();
        } else {
            // Nếu đang chơi -> Nhảy
            if (!is_jumping) {
                is_jumping = 1;
                jump_velocity = jump_initial_velocity;
                player_y -= 1; // Bắt đầu nhảy
            }
        }
    }
}

void Game_ProcessTick(void) {

    // 1. Xóa cờ sự kiện ngay lập tức
    g_game_tick_event = false;

    // 2. Cập nhật Logic Game (CHỈ KHI ĐANG CHƠI)
    if (!game_over) {
        game_cycle_counter++;

        // --- Cập nhật vật lý Player ---
        if (is_jumping) {
            player_y -= jump_velocity;
            jump_velocity -= gravity;
            if (player_y >= 40) { // Chạm đất
                player_y = 40;
                is_jumping = 0;
                jump_velocity = 0;
            }
        }

        // --- Cập nhật xương rồng ---
        for (int i = 0; i < NUM_CACTI; i++) {
            if (cacti[i].x > 0) {
                cacti[i].x -= GROUND_CACTI_SCROLL_SPEED;
                if (cacti[i].x < 5) cacti[i].x = 0; // Ra khỏi màn hình
            } else {
                // Tạo xương rồng mới
                if (rand() % 100 == 0) {
                    cacti[i].w = (rand() % 2 == 0) ? 17 : 12;
                    cacti[i].h = (cacti[i].w == 17) ? 18 : 13;
                    cacti[i].bitmap = (cacti[i].w == 17) ? cacti_big_big_bitmap : cacti_small_big_bitmap;
                    cacti[i].mask = (cacti[i].w == 17) ? cacti_big_big_mask : cacti_small_big_mask;
                    cacti[i].x = SSD1306_WIDTH + (rand() % 50);
                    cacti[i].y = GROUND_Y + 1 - cacti[i].h;
                    break; // Mỗi tick chỉ tạo 1 xương rồng
                }
            }
        }

        // --- Kiểm tra va chạm ---
        bool collision_detected = false;
        if (player_y < 57) { // Chỉ kiểm tra khi khủng long không ở trạng thái duck
            for (int i = 0; i < NUM_CACTI; i++) {
                if (cacti[i].x > 0 && cacti[i].x < (10 + 16 - 4) && (player_y + 16 - 4) > cacti[i].y) {
                    collision_detected = true;
                    break;
                }
            }
        }

        if (collision_detected && !has_collided) {
            has_collided = true;
            lives--;
            if (lives == 0) {
                game_over = true;
            }
        } else if (!collision_detected) {
            has_collided = false;
        }

        // --- Cập nhật điểm và chế độ ngày/đêm ---
        score++;
        if (score > hi_score) hi_score = score;

        if (score % DAY_NIGHT_SWITCH_CYCLES == 0) {
            night = !night;
            ssd1306_WriteCommand(night ? 0xA7 : 0xA6); // Invert display
        }
    }

    if (game_over) {
        // Vẽ màn hình Game Over
        ssd1306_SetCursor(20, 18);
        ssd1306_WriteString("GAME OVER", Font_11x18, White);
        ssd1306_DrawBitmap(60, 38, restart_small_bitmap, 8, 8, White);
    } else {
        // --- Vẽ Player ---
        player_anim_frame = (player_anim_frame + 1) % 15; // 3 frames, 5 tick mỗi frame
        const uint8_t *bmp, *mask;
        if (is_jumping) {
            bmp = trex_up_1s_bitmap; mask = trex_up_1s_mask;
        } else {
            if (player_anim_frame < 5) {
                bmp = trex_up_1s_bitmap; mask = trex_up_1s_mask;
            } else if (player_anim_frame < 10) {
                bmp = trex_up_2s_bitmap; mask = trex_up_2s_mask;
            } else {
                bmp = trex_up_3s_bitmap; mask = trex_up_3s_mask;
            }
        }
        ssd1306_DrawBitmap_Masked(10, player_y, bmp, mask, 20, 24, White);

        // --- Vẽ Xương rồng ---
        for (int i = 0; i < NUM_CACTI; i++) {
            if (cacti[i].x > 0) {
                ssd1306_DrawBitmap_Masked(cacti[i].x, cacti[i].y, cacti[i].bitmap, cacti[i].mask, cacti[i].w, cacti[i].h, White);
            }
        }

        Render_Ground(GROUND_Y);

        ssd1306_SetCursor(10, 0);
        ssd1306_WriteString("HI", Font_7x10, White);
        Render_Number(28, 0, hi_score);
        Render_Number(80, 0, score);
        Render_Heart(lives);
    }

    // 4. ĐẨY BUFFER RA MÀN HÌNH (Đây là hàm blocking duy nhất)
    ssd1306_UpdateScreen();
    ssd1306_Fill(Black);
}
