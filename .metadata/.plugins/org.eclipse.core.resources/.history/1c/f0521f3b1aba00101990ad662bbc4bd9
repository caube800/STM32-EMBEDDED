#include <string.h>
#include <stdio.h>
#include <stdlib.h>
#include "ssd1306.h"
#include "ssd1306_tests.h"
#include "ssd1306_fonts.h"

volatile int is_jumping = 0;  // 0: running bình thường, 1: đang nhảy
volatile int jump_velocity = 0;  // Độ cao nhảy hiện tại (shift y)
const int gravity = 2;  // Gravity pull down
const int jump_initial_velocity = 12;  // Sức nhảy ban đầu
volatile int ground_scroll = 0;  // Scroll ground (di chuyển sàn)
const int ground_speed = 3;  // Tốc độ scroll ground (pixels/cycle, như Arduino)



const uint8_t trex_up_1s_bitmap[] = {
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x07, 0xfe, 0x00,
    0x00, 0x06, 0xff, 0x00,
    0x00, 0x0e, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xc0, 0x00,
    0x00, 0x0f, 0xfc, 0x00,
    0x40, 0x0f, 0xc0, 0x00,
    0x40, 0x1f, 0x80, 0x00,
    0x40, 0x7f, 0x80, 0x00,
    0x60, 0xff, 0xe0, 0x00,
    0x71, 0xff, 0xa0, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x3f, 0xff, 0x00, 0x00,
    0x1f, 0xff, 0x00, 0x00,
    0x0f, 0xfe, 0x00, 0x00,
    0x03, 0xfc, 0x00, 0x00,
    0x01, 0xdc, 0x00, 0x00,
    0x01, 0x8c, 0x00, 0x00,
    0x01, 0x8c, 0x00, 0x00,
    0x01, 0x0c, 0x00, 0x00,
    0x01, 0x8e, 0x00, 0x00
};

const uint8_t trex_up_1s_mask[] = {  // Copy bitmap cho mask cơ bản (set 0xFF ở vùng pixel để clear)
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x07, 0xfe, 0x00,
    0x00, 0x07, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xc0, 0x00,
    0x00, 0x0f, 0xfc, 0x00,
    0x40, 0x0f, 0xc0, 0x00,
    0x40, 0x1f, 0x80, 0x00,
    0x40, 0x7f, 0x80, 0x00,
    0x60, 0xff, 0xe0, 0x00,
    0x71, 0xff, 0xa0, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x3f, 0xff, 0x00, 0x00,
    0x1f, 0xff, 0x00, 0x00,
    0x0f, 0xfe, 0x00, 0x00,
    0x03, 0xfc, 0x00, 0x00,
    0x01, 0xdc, 0x00, 0x00,
    0x01, 0x8c, 0x00, 0x00,
    0x01, 0x8c, 0x00, 0x00,
    0x01, 0x0c, 0x00, 0x00,
    0x01, 0x8e, 0x00, 0x00
};

const uint8_t trex_up_2s_bitmap[] = {
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x07, 0xfe, 0x00,
    0x00, 0x06, 0xff, 0x00,
    0x00, 0x0e, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xc0, 0x00,
    0x00, 0x0f, 0xfc, 0x00,
    0x40, 0x0f, 0xc0, 0x00,
    0x40, 0x1f, 0x80, 0x00,
    0x40, 0x7f, 0x80, 0x00,
    0x60, 0xff, 0xe0, 0x00,
    0x71, 0xff, 0xa0, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x3f, 0xff, 0x00, 0x00,
    0x1f, 0xff, 0x00, 0x00,
    0x0f, 0xfe, 0x00, 0x00,
    0x03, 0xfc, 0x00, 0x00,
    0x01, 0xfc, 0x00, 0x00,
    0x01, 0x8c, 0x00, 0x00,
    0x01, 0x8c, 0x00, 0x00,
    0x01, 0x0e, 0x00, 0x00,
    0x01, 0x86, 0x00, 0x00
};

const uint8_t trex_up_2s_mask[] = {  // Tương tự, copy và adjust nếu cần
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x07, 0xfe, 0x00,
    0x00, 0x07, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xc0, 0x00,
    0x00, 0x0f, 0xfc, 0x00,
    0x40, 0x0f, 0xc0, 0x00,
    0x40, 0x1f, 0x80, 0x00,
    0x40, 0x7f, 0x80, 0x00,
    0x60, 0xff, 0xe0, 0x00,
    0x71, 0xff, 0xa0, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x3f, 0xff, 0x00, 0x00,
    0x1f, 0xff, 0x00, 0x00,
    0x0f, 0xfe, 0x00, 0x00,
    0x03, 0xfc, 0x00, 0x00,
    0x01, 0xfc, 0x00, 0x00,
    0x01, 0x8c, 0x00, 0x00,
    0x01, 0x8c, 0x00, 0x00,
    0x01, 0x0e, 0x00, 0x00,
    0x01, 0x86, 0x00, 0x00
};

const uint8_t trex_up_3s_bitmap[] = {
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x07, 0xfe, 0x00,
    0x00, 0x06, 0xff, 0x00,
    0x00, 0x0e, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xc0, 0x00,
    0x00, 0x0f, 0xfc, 0x00,
    0x40, 0x0f, 0xc0, 0x00,
    0x40, 0x1f, 0x80, 0x00,
    0x40, 0x7f, 0x80, 0x00,
    0x60, 0xff, 0xe0, 0x00,
    0x71, 0xff, 0xa0, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x3f, 0xff, 0x00, 0x00,
    0x1f, 0xff, 0x00, 0x00,
    0x0f, 0xfe, 0x00, 0x00,
    0x03, 0xfc, 0x00, 0x00,
    0x01, 0xdc, 0x00, 0x00,
    0x01, 0x8c, 0x00, 0x00,
    0x01, 0x8c, 0x00, 0x00,
    0x01, 0x06, 0x00, 0x00,
    0x01, 0x83, 0x00, 0x00
};

const uint8_t trex_up_3s_mask[] = {  // Copy và adjust
    0x00, 0x00, 0x00, 0x00,
    0x00, 0x07, 0xfe, 0x00,
    0x00, 0x07, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xff, 0x00,
    0x00, 0x0f, 0xc0, 0x00,
    0x00, 0x0f, 0xfc, 0x00,
    0x40, 0x0f, 0xc0, 0x00,
    0x40, 0x1f, 0x80, 0x00,
    0x40, 0x7f, 0x80, 0x00,
    0x60, 0xff, 0xe0, 0x00,
    0x71, 0xff, 0xa0, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x7f, 0xff, 0x80, 0x00,
    0x3f, 0xff, 0x00, 0x00,
    0x1f, 0xff, 0x00, 0x00,
    0x0f, 0xfe, 0x00, 0x00,
    0x03, 0xfc, 0x00, 0x00,
    0x01, 0xdc, 0x00, 0x00,
    0x01, 0x8c, 0x00, 0x00,
    0x01, 0x8c, 0x00, 0x00,
    0x01, 0x06, 0x00, 0x00,
    0x01, 0x83, 0x00, 0x00
};

const uint8_t trex_duck_1s_bitmap[] = {
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x1f, 0xff, 0xc0, 0x08, 0x46,
    0x1f, 0xe0, 0x70, 0xff, 0x3f,
    0x7f, 0xff, 0xf7, 0xf0, 0x3f,
    0xff, 0xff, 0xf0, 0x9f, 0xff,
    0xff, 0xf0, 0xcf, 0xff, 0xff,
    0xf0, 0xe7, 0xff, 0xfe, 0x00,
    0xf3, 0xff, 0x9f, 0xc0, 0xc1,
    0xf9, 0x00, 0x00, 0xc3, 0x9d
};

const uint8_t trex_duck_1s_mask[] = {
    0xe0, 0x00, 0x3f, 0xf0, 0xf9,
    0xff, 0xff, 0xf8, 0xff, 0xff,
    0xff, 0xf8, 0xff, 0xff, 0xff,
    0xf8, 0xff, 0xff, 0xff, 0xf8,
    0x7f, 0xff, 0xff, 0xf8, 0x3f,
    0xff, 0xff, 0xf8, 0x1f, 0xff,
    0xff, 0xf8, 0x0f, 0xff, 0xff,
    0xe0, 0x07, 0xff, 0xff, 0xe0,
    0x07, 0xff, 0xc0, 0x00, 0x07,
    0x9f, 0xc0, 0x00, 0x07, 0x80,
    0x00, 0x00, 0x07, 0x80, 0x00,
    0x00, 0x07, 0x80, 0x00, 0x00,
    0x07, 0x80, 0x00, 0x00, 0x07,
    0x80, 0x00, 0x00, 0x07, 0x80,
    0x00, 0x00, 0x07, 0x80, 0x00,
    0x00, 0x07, 0x80, 0x00, 0x00,
    0x07, 0x80, 0x00, 0x00, 0x07,
    0x80, 0x00, 0x00
};

const uint8_t trex_duck_2s_bitmap[] = {
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00,
    0x1f, 0xff, 0xc0, 0x08, 0x46,
    0x1f, 0xe0, 0x70, 0xff, 0x3f,
    0x7f, 0xff, 0xf7, 0xf0, 0x3f,
    0xff, 0xff, 0xf0, 0x9f, 0xff,
    0xff, 0xf0, 0xcf, 0xff, 0xff,
    0xf0, 0xe7, 0xff, 0xfe, 0x00,
    0xf3, 0xff, 0x9f, 0xc0, 0xc1,
    0xf9, 0x00, 0x00, 0xc3, 0x9d
};

const uint8_t trex_duck_2s_mask[] = {
    0xe0, 0x00, 0x3f, 0xf0, 0xf9,
    0xff, 0xff, 0xf8, 0xff, 0xff,
    0xff, 0xf8, 0xff, 0xff, 0xff,
    0xf8, 0xff, 0xff, 0xff, 0xf8,
    0x7f, 0xff, 0xff, 0xf8, 0x3f,
    0xff, 0xff, 0xf8, 0x1f, 0xff,
    0xff, 0xf8, 0x0f, 0xff, 0xff,
    0xe0, 0x07, 0xff, 0xff, 0xe0,
    0x07, 0xff, 0xc0, 0x00, 0x07,
    0x9f, 0xc0, 0x00, 0x07, 0x80,
    0x00, 0x00, 0x07, 0x80, 0x00,
    0x00, 0x07, 0x80, 0x00, 0x00,
    0x07, 0x80, 0x00, 0x00, 0x07,
    0x80, 0x00, 0x00, 0x07, 0x80,
    0x00, 0x00, 0x07, 0x80, 0x00,
    0x00, 0x07, 0x80, 0x00, 0x00,
    0x07, 0x80, 0x00, 0x00, 0x07,
    0x80, 0x00, 0x00
};

const uint8_t ground_bitmap[] = {
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x10, 0x00, 0x04, 0x00, 0x10, 0x00, 0x04, 0x00, 0x10, 0x00, 0x04, 0x00, 0x10, 0x00, 0x04, 0x00,
    0x28, 0x00, 0x0a, 0x00, 0x28, 0x00, 0x0a, 0x00, 0x28, 0x00, 0x0a, 0x00, 0x28, 0x00, 0x0a, 0x00,
    0x54, 0x00, 0x15, 0x00, 0x54, 0x00, 0x15, 0x00, 0x54, 0x00, 0x15, 0x00, 0x54, 0x00, 0x15, 0x00,
    0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff
};  // Tổng 128 bytes (16 bytes x 8 rows)

const uint8_t cacti_big_big_bitmap[] = {

0x00, 0x00, 0x00, 0x00, 0x7B, 0x7B, 0xDB, 0xE0, 0x77, 0xBB, 0xBD, 0xE0, 0x77, 0xBE, 0xBD, 0xE0,
0x77, 0xBD, 0x3D, 0xE0, 0x77, 0xAB, 0xBD, 0x60, 0x57, 0x93, 0xBC, 0xA0, 0x27, 0xBB, 0xBD, 0xC0,
0x77, 0xBB, 0xBD, 0xC0, 0x77, 0xBB, 0xBD, 0xC0, 0x77, 0xBB, 0xBD, 0xC0, 0x77, 0xBB, 0xFD, 0xC0,
0x77, 0xB9, 0xFD, 0xC0, 0x77, 0xBA, 0xFF, 0xC0, 0x7F, 0xF7, 0x3F, 0xA0, 0x3F, 0xE8, 0x3F, 0x60,
0x5F, 0x98, 0x3C, 0xE0, 0x67, 0xB8, 0x3D, 0xE0, 0x77, 0xBB, 0xBD, 0xE0, 0x77, 0xBB, 0xBD, 0xE0,
0x77, 0xBB, 0xBC, 0x00, 0x77, 0xBB, 0xBC, 0x00, 0x47, 0x8A, 0x3C, 0x00, 0x5F, 0xAA, 0xFC, 0x60,
0x40, 0x0A, 0x01, 0x60, 0x01, 0x00, 0x40, 0x00,
};

const uint8_t cacti_big_big_mask[] = {

0x03, 0x00, 0x18, 0x00, 0x07, 0x80, 0x3C, 0x00, 0x0F, 0xC0, 0x7E, 0x00, 0x0F, 0xC1, 0x7E, 0x00,
0x0F, 0xC3, 0xFE, 0x00, 0x0F, 0xD7, 0xFE, 0x80, 0x2F, 0xFF, 0xFF, 0xC0, 0x7F, 0xFF, 0xFF, 0xE0,
0xFF, 0xFF, 0xFF, 0xE0, 0xFF, 0xFF, 0xFF, 0xE0, 0xFF, 0xFF, 0xFF, 0xE0, 0xFF, 0xFF, 0xFF, 0xE0,
0xFF, 0xFF, 0xFF, 0xE0, 0xFF, 0xFD, 0xFF, 0xE0, 0xFF, 0xF8, 0xFF, 0xC0, 0x7F, 0xF0, 0x7F, 0x80,
0x3F, 0xE0, 0x7F, 0x00, 0x1F, 0xC0, 0x7E, 0x00, 0x0F, 0xC0, 0x7E, 0x00, 0x0F, 0xC0, 0x7E, 0x00,
0x0F, 0xC0, 0x7E, 0x00, 0x0F, 0xC0, 0x7E, 0x00, 0x3F, 0xF1, 0xFE, 0x00, 0x3F, 0xF1, 0xFF, 0x80,
0x3F, 0xF1, 0xFF, 0x80, 0xFF, 0xFF, 0xFF, 0xE0,
};

const uint8_t cacti_small_big_bitmap[] = {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x68, 0x75, 0xD6, 0xE0,
0x6C, 0xCE, 0xA6, 0x60, 0x6D, 0x2E, 0xB6, 0xA0, 0x4D, 0xAE, 0x36, 0xC0, 0x2D, 0xAE, 0xB6, 0xC0,
0x6D, 0xAE, 0xB6, 0xC0, 0x6D, 0xAE, 0xB6, 0xC0, 0x6D, 0xAE, 0xB6, 0xC0, 0x6F, 0x2E, 0x9E, 0xC0,
0x6C, 0xAE, 0xA7, 0xA0, 0x3D, 0xBE, 0xB6, 0x60, 0x4D, 0xDF, 0xB6, 0xE0, 0x6D, 0xEF, 0x76, 0xE0,
0x6D, 0xEE, 0xF6, 0xE0, 0x6D, 0xEE, 0xF6, 0xE0, 0x6D, 0xEE, 0xF6, 0xE0, 0x6D, 0x8E, 0x16, 0x00,
0x60, 0x20, 0x50, 0x40, 0x01, 0x00, 0x02, 0x00,
};

const uint8_t cacti_small_big_mask[] = {
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x00, 0x06, 0x00, 0x1C, 0x0E, 0x2F, 0x00,
0x1F, 0x3F, 0x7F, 0x80, 0x1F, 0xFF, 0x7F, 0xC0, 0x3F, 0xFF, 0xFF, 0xE0, 0x7F, 0xFF, 0xFF, 0xE0,
0xFF, 0xFF, 0xFF, 0xE0, 0xFF, 0xFF, 0xFF, 0xE0, 0xFF, 0xFF, 0xFF, 0xE0, 0xFF, 0xFF, 0xFF, 0xE0,
0xFF, 0x7F, 0xDF, 0xC0, 0x7E, 0x7F, 0xCF, 0x80, 0x3E, 0x3F, 0xCF, 0x00, 0x1E, 0x1F, 0x8F, 0x00,
0x1E, 0x1F, 0x0F, 0x00, 0x1E, 0x1F, 0x0F, 0x00, 0x1E, 0x1F, 0x0F, 0x00, 0x1E, 0x7F, 0xEF, 0xE0,
0x1F, 0xFF, 0xEF, 0xE0, 0xFF, 0xFF, 0xFF, 0xE0,
};

const uint8_t heart_bitmap[] = {  // W=8, H=8 (placeholder, replace with hearts_5x_bm from GitHub, adjust for single)
    0x00, 0x66, 0xff, 0xff, 0x7e, 0x3c, 0x18, 0x00
};
const uint8_t hi_score_bitmap[] = {  // W=16, H=8 (placeholder, replace with hi_score_bm)
    0xff, 0x81, 0x81, 0x81, 0xff, 0x00, 0xff, 0x81, 0x81, 0x81, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00  // "HI"
};
const uint8_t restart_small_bitmap[] = {
    0x10,
    0x30,
    0x70,
    0xF0,
    0xF0,
    0x70,
    0x30,
    0x10
};

// Struct Sprite
typedef struct {
    uint8_t x, y;
    uint8_t w, h;
    const uint8_t *bitmap;
    uint8_t frame;
} Sprite;

// Sprites
Sprite trex = {10, 32, 25, 26, trex_up_1s_bitmap, 0};
Sprite heart = {255, 20, 8, 8, heart_bitmap, 0};

Cactus_t cactus1 = {128, 34, 32, 26, cacti_big_big_bitmap, cacti_big_big_mask};
Cactus_t cactus2 = {200, 34, 32, 26, cacti_small_big_bitmap, cacti_small_big_mask};

// Biến game
uint16_t score = 0;
uint16_t hi_score = 0;
uint8_t lives = LIVES_START;
bool game_over = false;
uint8_t target_fps = TARGET_FPS_START;
bool night = false;
uint32_t last_heart_spawn = 0;

void Save_Hi_Score(uint16_t score) {
    HAL_FLASH_Unlock();
    FLASH_EraseInitTypeDef EraseInitStruct;
    EraseInitStruct.TypeErase = FLASH_TYPEERASE_PAGES;
    EraseInitStruct.PageAddress = 0x0800FC00;
    EraseInitStruct.NbPages = 1;
    uint32_t PageError = 0;
    HAL_FLASHEx_Erase(&EraseInitStruct, &PageError);
    HAL_FLASH_Program(FLASH_TYPEPROGRAMDATA_HALFWORD, 0x0800FC00, score);
    HAL_FLASH_Lock();
}

// Hàm ssd1306_DrawBitmap_Masked
void ssd1306_DrawBitmap_Masked(uint8_t x, uint8_t y, const uint8_t *bitmap,
                               const uint8_t *mask, uint8_t w, uint8_t h,
                               SSD1306_COLOR color) {
    int16_t byteWidth = (w + 7) / 8;
    uint8_t byteB, byteM;

    for (uint8_t j = 0; j < h; j++) {
        for (uint8_t i = 0; i < w; i++) {
            if (i % 8 == 0) {
                byteB = bitmap[j * byteWidth + i / 8];
                byteM = mask[j * byteWidth + i / 8];
            } else {
                byteB <<= 1;
                byteM <<= 1;
            }

            if (byteM & 0x80) {
                // nếu pixel này thuộc vùng mask
                if (byteB & 0x80)
                    ssd1306_DrawPixel(x + i, y + j, color);
                else
                    ssd1306_DrawPixel(x + i, y + j, Black);
            }
        }
    }
}
// Hàm Render_Ground
void Render_Ground(uint8_t y) {
    // Vẽ đường thẳng bottom với scroll (di chuyển liên tục)
    // Sử dụng ssd1306_Line để vẽ line dài 128px, nhưng shift position để scroll
    int start_x = ground_scroll % 128;  // Scroll loop từ 0 đến 127
    ssd1306_Line(start_x, y, 127, y, White);  // Vẽ từ start_x đến end screen
    if (start_x > 0) {
        ssd1306_Line(0, y, start_x - 1, y, White);  // Vẽ phần còn lại từ đầu
    }
    ground_scroll = (ground_scroll + ground_speed) % 128;  // Update scroll mượt
}

// Hàm Check_Collision
bool Check_Collision(uint8_t x1, uint8_t y1, uint8_t w1, uint8_t h1, uint8_t x2, uint8_t y2, uint8_t w2, uint8_t h2) {
    return (x1 < x2 + w2 && x1 + w1 > x2 && y1 < y2 + h2 && y1 + h1 > y2);
}

// Hàm Render_Number
void Render_Number(uint8_t x, uint8_t y, uint16_t number) {
    char str[6];
    sprintf(str, "%05u", number);  // Hiển thị 5 chữ số, thêm 0 phía trước
    ssd1306_SetCursor(x, y);
    ssd1306_WriteString(str, Font_7x10, White);
}

// Hàm Render_Heart
void Render_Heart(uint8_t lives) {
    for (uint8_t i = 0; i < lives; i++) {
        ssd1306_DrawBitmap(95 + i*10, 8, heart_bitmap, 8, 8, White);
    }
}

void Draw_Restart_Icon(uint8_t x, uint8_t y) {
    // Tam giác nhỏ (8x8), mũi tên phải
    ssd1306_Line(x, y, x + 7, y + 4, White);     // cạnh trên
    ssd1306_Line(x + 7, y + 4, x, y + 8, White); // cạnh dưới
    ssd1306_Line(x, y, x, y + 8, White);         // cạnh trái

    // Tô bên trong (tùy chọn)
    for (int i = 1; i < 7; i++) {
        ssd1306_Line(x + i, y + 1, x + i, y + 7, White);
    }
}

// Hàm Game_Loop
void Game_Loop(void) {
    uint32_t prv_t = HAL_GetTick();
    uint32_t cycle_count = 0;

    hi_score = *(__IO uint16_t*)0x0800FC00;

    while (1) {
        ssd1306_Fill(Black);

        if (is_jumping) {
            trex.y -= jump_velocity;
            jump_velocity -= gravity;
            if (trex.y >= 32) {
                trex.y = 32;
                is_jumping = 0;
                jump_velocity = 0;
            }
        }

        trex.frame = (trex.frame + 1) % 3;
        const uint8_t *mask = trex_up_1s_mask;  // Adjust for each frame if needed
        switch (trex.frame) {
            case 0: trex.bitmap = trex_up_1s_bitmap; break;
            case 1: trex.bitmap = trex_up_2s_bitmap; break;
            case 2: trex.bitmap = trex_up_3s_bitmap; break;
        }
        ssd1306_DrawBitmap_Masked(trex.x, trex.y, trex.bitmap, mask, trex.w, trex.h, White);

        cactus1.x -= GROUND_CACTI_SCROLL_SPEED;
        cactus2.x -= GROUND_CACTI_SCROLL_SPEED;

        if (cactus1.x + cactus1.w < 0) {
            cactus1.x = 128 + (rand() % 100);
            if (rand() % 2) {
                cactus1.bitmap = cacti_big_big_bitmap;
                cactus1.mask = cacti_big_big_mask;
            } else {
                cactus1.bitmap = cacti_small_big_bitmap;
                cactus1.mask = cacti_small_big_mask;
            }
        }

        if (cactus2.x + cactus2.w < 0) {
            cactus2.x = cactus1.x + PLAYER_SAFE_ZONE_WIDTH + (rand() % 200);
            if (rand() % 2) {
                cactus2.bitmap = cacti_big_big_bitmap;
                cactus2.mask = cacti_big_big_mask;
            } else {
                cactus2.bitmap = cacti_small_big_bitmap;
                cactus2.mask = cacti_small_big_mask;
            }
        }
        ssd1306_DrawBitmap_Masked(cactus1.x, cactus1.y, cactus1.bitmap, cactus1.mask, cactus1.w, cactus1.h, White);
        ssd1306_DrawBitmap_Masked(cactus2.x, cactus2.y, cactus2.bitmap, cactus2.mask, cactus2.w, cactus2.h, White);

        if (cycle_count - last_heart_spawn > SPAWN_NEW_LIVE_MIN_CYCLES && lives < LIVES_MAX) {
            heart.x = 128 + (rand() % 50);
            last_heart_spawn = cycle_count;
        }
        if (heart.x < 255) {
            heart.x -= GROUND_CACTI_SCROLL_SPEED;
            ssd1306_DrawBitmap(heart.x, heart.y, heart.bitmap, heart.w, heart.h, White);
            if (Check_Collision(trex.x, trex.y, trex.w, trex.h, heart.x, heart.y, heart.w, heart.h)) {
                lives = (lives + 1 > LIVES_MAX) ? LIVES_MAX : lives + 1;
                heart.x = 255;
            }
            if (heart.x + heart.w < 0) heart.x = 255;
        }

        if (Check_Collision(trex.x, trex.y, trex.w, trex.h, cactus1.x, cactus1.y, cactus1.w, cactus1.h) ||
            Check_Collision(trex.x, trex.y, trex.w, trex.h, cactus2.x, cactus2.y, cactus2.w, cactus2.h)) {
            lives--;
            if (lives == 0) game_over = true;
        }

        Render_Ground(57);

        score++;
        if (score > hi_score) hi_score = score;
        // Hiển thị HI
        ssd1306_SetCursor(10, 0);
        ssd1306_WriteString("HI", Font_7x10, White);

        // Hiển thị điểm cao nhất
        Render_Number(28, 0, hi_score);

        // Hiển thị điểm hiện tại
        Render_Number(80, 0, score);
        Render_Heart(lives);

        if (score % DAY_NIGHT_SWITCH_CYCLES == 0) {
            night = !night;
            ssd1306_WriteCommand(night ? 0xA7 : 0xA6);
        }

        if (score % INCREASE_FPS_EVERY_N_SCORE_POINTS == 0 && target_fps < TARGET_FPS_MAX) target_fps++;

        if (game_over) {
        	ssd1306_SetCursor(20, 18);
        	ssd1306_WriteString("GAME OVER", Font_11x18, White);
        	ssd1306_DrawBitmap(60, 38, restart_small_bitmap, 8, 8, White);
            ssd1306_UpdateScreen();
            while (HAL_GPIO_ReadPin(GPIOC, GPIO_PIN_13) == GPIO_PIN_SET);  // Chờ low
            HAL_Delay(50);
            score = 0;
            lives = LIVES_START;
            game_over = false;
            cactus1.x = 128;
            cactus2.x = 200;
            heart.x = 255;
            Save_Hi_Score(hi_score);
        } else {
            ssd1306_UpdateScreen();
        }

        uint32_t frame_time = 1000 / target_fps;
        while (HAL_GetTick() - prv_t < frame_time);
        prv_t = HAL_GetTick();
        cycle_count++;
    }
}
